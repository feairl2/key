<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Feairl Key System</title>

<!-- å­—é«” -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        background: #0b0b0d; /* è¶…æ·±è‰² */
        font-family: 'Inter', sans-serif;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
    }

    .container {
        width: 550px;   /* é¢æ¿æ”¾å¤§ */
        padding: 40px;
        background: rgba(20, 20, 25, 0.9); /* æ·±è‰² + å¾®é€æ˜ */
        border-radius: 18px;
        box-shadow: 0 0 40px rgba(0,0,0,0.45);
        text-align: center;
    }

    h1 {
        margin-bottom: 18px;
        font-size: 30px;
        font-weight: 700;
    }

    #keyBox {
        margin-top: 25px;
        font-size: 22px;
        font-weight: 600;
        padding: 15px;
        background: #16161a;
        border-radius: 10px;
        word-break: break-all;
        border: 1px solid #2a2a33;
    }

    .loading {
        margin-top: 30px;
        font-size: 18px;
        opacity: 0.7;
    }
</style>
</head>
<body>

<div class="container">
    <h1>ğŸ”‘ Feairl Key System</h1>
    <div id="keyBox">æ­£åœ¨é©—è­‰ä¸­...</div>
    <div class="loading">è«‹ç¨å€™...</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// =====================================================
// Step 1ï¼šè®€å– Tokenï¼ˆä¸èƒ½ç¼ºï¼‰
// =====================================================
const urlParams2 = new URLSearchParams(window.location.search);
const token = urlParams2.get("token");

if (!token) {
    document.body.innerHTML = `
        <div style="color:white; text-align:center; margin-top:150px; font-size:26px;">
            è«‹å…ˆå®Œæˆ Work.ink é©—è­‰æ‰èƒ½é ˜å–é‡‘é‘°
        </div>
    `;
    throw new Error("ç¼ºå°‘ Token");
}

// =====================================================
// Firebase è¨­å®š
// =====================================================
const firebaseConfig2 = {
    apiKey: "AIzaSyCRdYTxHGhDQvQgnzwIWutPhXLfFm4485X0",
    authDomain: "keysystem-2f263.firebaseapp.com",
    databaseURL: "https://keysystem-2f263-default-rtdb.firebaseio.com",
    projectId: "keysystem-2f263",
    storageBucket: "keysystem-2f263.firebasestorage.app",
    messagingSenderId: "212352827734",
    appId: "1:212352827734:web:f2b0f401d206ac483796f7",
    measurementId: "G-83FH95F22W"
};
firebase.initializeApp(firebaseConfig2);

const db2 = firebase.database();

// =====================================================
// Step 2ï¼šæª¢æŸ¥ Token æ˜¯å¦å­˜åœ¨
// =====================================================
db2.ref("tokens/" + token).once("value").then(snapshot => {

    if (!snapshot.exists()) {

        document.querySelector("#keyBox").innerHTML = `
            âŒ Token å·²å¤±æ•ˆæˆ–ä¸åˆæ³•<br><br>è«‹é‡æ–°å®Œæˆ Work.ink
        `;
        document.querySelector(".loading").style.display = "none";
        throw new Error("Invalid token");
    }

    // Token æœ‰æ•ˆ â†’ åˆªé™¤å®ƒï¼ˆä¸€æ¬¡æ€§ï¼‰
    db2.ref("tokens/" + token).remove();

    // =====================================================
    // Step 3ï¼šç”¢ç”Ÿé‡‘é‘°ï¼ˆæ¯äºº 24 å°æ™‚ä¸€æ¬¡ï¼‰
    // =====================================================

    let savedKey = localStorage.getItem("feairl_key");
    let expire = localStorage.getItem("feairl_expire");
    let now = Date.now();

    // å¦‚æœæœ‰èˆŠé‡‘é‘°è€Œä¸”é‚„æ²’éæœŸ â†’ é‡ç”¨
    if (savedKey && expire && now < parseInt(expire)) {

        document.querySelector("#keyBox").textContent = savedKey;
        document.querySelector(".loading").textContent = "ä»Šæ—¥é‡‘é‘°å·²è¼‰å…¥ âœ”";
        return;
    }

    // å¦å‰‡ â†’ ç”¢ç”Ÿæ–°é‡‘é‘°
    function generateNewKey() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let key = "";
        for (let i = 0; i < 30; i++) {
            key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return key;
    }

    let newKey = generateNewKey();
    let expireTime = now + 24 * 60 * 60 * 1000; // 24 å°æ™‚å¾ŒéæœŸ

    // å­˜å…¥ localStorage
    localStorage.setItem("feairl_key", newKey);
    localStorage.setItem("feairl_expire", expireTime.toString());

    // é¡¯ç¤ºæ–°é‡‘é‘°
    document.querySelector("#keyBox").textContent = newKey;
    document.querySelector(".loading").textContent = "é‡‘é‘°å·²ç”¢ç”Ÿ âœ”";

});
</script>

</body>
</html>
